<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="local">
	<!-- 통계 날짜 -->
	<select id="hsDateSearch" resultType="humanStatisVo">
		select DISTINCT hs_date
		from human_statistic
		where hs_date >= '201706'
		order by hs_date
	</select>


	<!-- 월별 전체 인구 통계 -->
	<select id="allHumanStatis" parameterType="String" resultType="humanStatisVo">
		select
		hs_date,
		sum(hs_hm_no) as hs_hm_no
		from human_statistic
		where hs_dong like #{hs_dong} ||'%'
		and hs_date >= '201706'
		group by
		hs_date
		order by hs_date
	</select>

	<!-- 월별 전체 인구 최댓값 -->
	<select id="allHumanStatisMaxValue" parameterType="String" resultType="int">
		select max(sum(hs_hm_no)) as maxCnt
		from human_statistic
		where hs_dong like #{hs_dong} || '%'
		and hs_date >= '201706'
		group by
		hs_date
		order by hs_date
	</select>

	<!-- 월별 전체 인구 최솟값 -->
	<select id="allHumanStatisMinValue" parameterType="String" resultType="int">
		select min(sum(hs_hm_no)) as minCnt
		from human_statistic
		where hs_dong like #{hs_dong} || '%'
		and hs_date >= '201706'
		group by
		hs_date
		order by hs_date
	</select>

	<!-- 월별, 성별 인구 통계 -->
	<select id="gndrHumanStatis" parameterType="String" resultType="humanStatisVo">
		select
		hs_date,
		decode(hs_gndr,0,'남자','여자') as hs_gndr,
		sum(hs_hm_no) as hs_hm_no
		from human_statistic
		where hs_dong like
		#{hs_dong} || '%'
		and hs_date >= '201706'
		group by
		hs_date,
		decode(hs_gndr,0,'남자','여자')
		order by
		hs_date
	</select>

	<!-- 남여 총 성비 -->
	<select id="gndrHumanStatisCricle" parameterType="String" resultType="humanStatisVo">
		select
		decode(hs_gndr, '0','남자','여자') as hs_gndr,
		sum(hs_hm_no) as hs_hm_no
		from human_statistic
		where hs_dong like
		#{hs_dong} || '%'
		and hs_date >= '201706'
		group by
		hs_gndr
	</select>

	<!-- 성별 인구 최댓값 -->
	<select id="gndrHumanStatisMaxValue" parameterType="String"
		resultType="int">
		select max(sum(hs_hm_no)) as hs_hm_no
		from human_statistic
		where hs_dong like #{hs_dong} || '%'
		and hs_date >= '201706'
		group by
		hs_date,
		decode(hs_gndr,0,'남자','여자')
		order by
		hs_date
	</select>

	<!-- 성별 인구 최솟값 -->
	<select id="gndrHumanStatisMinValue" parameterType="String" resultType="int">
		select min(sum(hs_hm_no)) as hs_hm_no
		from human_statistic
		where hs_dong like #{hs_dong} || '%'
		and hs_date >= '201706'
		group by
		hs_date,
		decode(hs_gndr,0,'남자','여자')
		order by
		hs_date
	</select>

	<!-- 월별, 연령별 인구 통계 -->
	<select id="ageHumanStatis" parameterType="humanStatisVo" resultType="humanStatisVo">
		     select hs_date,hs_age_grp, sum(hs_hm_no) as hs_hm_no
            from
            HUMAN_STATISTIC 
            where hs_dong like #{dong}||'%'
            and hs_date >= '201706'
           <choose>
           	<when test="hs_age_grp != '70세 이상'">
           		and substr(hs_age_grp, 0,1) between '0' and '6'
            	and length(hs_age_grp) <![CDATA[ <= ]]> 6
            	<if test="hs_age_grp != null">
            		and hs_age_grp = #{hs_age_grp}
            	</if>
           	</when>
           	<when test="hs_age_grp == '70세 이상'">
           		and substr(hs_age_grp,0,1) between '7' and '9'
           	</when>
           </choose>
            group by hs_date, hs_age_grp
            order by hs_date
	</select>


	<!-- 연령별 인구통계 최댓값 -->
	<select id="ageHumanStatisMaxValue" parameterType="humanStatisVo" resultType="int">
		select a.hs_hm_no
		from
		(
		select *
		from
		(
		  select hs_date,hs_age_grp, sum(hs_hm_no) as hs_hm_no
            from
            HUMAN_STATISTIC 
            where hs_dong like #{dong}||'%'
            and hs_date >= '201706'
           <choose>
           	<when test="hs_age_grp != '70세 이상'">
           		and substr(hs_age_grp, 0,1) between '0' and '6'
            	and length(hs_age_grp) <![CDATA[ <= ]]> 6
            	<if test="hs_age_grp != null">
            		and hs_age_grp = #{hs_age_grp}
            	</if>
           	</when>
           	<when test="hs_age_grp == '70세 이상'">
           		and substr(hs_age_grp,0,1) between '7' and '9'
           	</when>
           </choose>
            group by hs_date, hs_age_grp
		)
		order by 3 desc
		) a
		where rownum <![CDATA[ <= ]]> 1
	</select>

	<!-- 연령별 인구통계 최솟값 -->
	<select id="ageHumanStatisMinValue" parameterType="humanStatisVo" resultType="int">
		select a.hs_hm_no
		from
		(
		select *
		from
		(
		 select hs_date,hs_age_grp, sum(hs_hm_no) as hs_hm_no
            from
            HUMAN_STATISTIC 
            where hs_dong like #{dong}||'%'
            and hs_date >= '201706'
           <choose>
           	<when test="hs_age_grp != '70세 이상'">
           		and substr(hs_age_grp, 0,1) between '0' and '6'
            	and length(hs_age_grp) <![CDATA[ <= ]]> 6
            	<if test="hs_age_grp != null">
            		and hs_age_grp = #{hs_age_grp}
            	</if>
           	</when>
           	<when test="hs_age_grp == '70세 이상'">
           		and substr(hs_age_grp,0,1) between '7' and '9'
           	</when>
           </choose>
            group by hs_date, hs_age_grp
		)
		order by 3
		) a
		where rownum <![CDATA[ <= ]]> 1
	</select>
	
	<!-- 연령대 출력 -->
	<select id="ageList" resultType="humanStatisVo">
		SELECT DISTINCT
		    hs_age_grp,
		    length(hs_age_grp)
		FROM
		    human_statistic
		WHERE
		    substr(hs_age_grp,0,1) BETWEEN '0' AND '6'
		    AND   length(hs_age_grp) <![CDATA[ <= ]]> 6
		UNION
		SELECT DISTINCT
		    '70세 이상' AS hs_age_grp,
		    length(hs_age_grp)
		FROM
		    human_statistic
		WHERE
		    substr(hs_age_grp,0,1) BETWEEN '7' AND '9'
		ORDER BY
		    2,
		    1
	</select>
	
	<select id="ageCircle" parameterType="humanStatisVo" resultType="humanStatisVo">
	select hs_age_grp, sum(hs_hm_no) as hs_hm_no
	from human_statistic
	where hs_dong like  #{dong}||'%'
	    and hs_date >= '201706'
	group by hs_age_grp
	order by length(hs_age_grp), hs_age_grp
	</select>

</mapper>