<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="admin_statis">

<!-- ** 회원 통계 ** -->
	<!-- 누적 회원 수 -->
	<select id="countAllMembers" resultType="int">
		Select count(mem_no) as counts From member Where mem_mngr is null
	</select>
	
	<!-- 현재 가입되어 있는 회원 수 -->
	<select id="countSignIn" resultType="int">
		Select count(mem_no) as counts From member Where mem_exdate is null And mem_mngr is null
	</select>

	<!-- 5일부터 오늘까지 일별 가입한 회원 수 -->
	<select id="signInDaily" resultType="memVo">
		Select count(mem_date) as counts , a.ymd as ymd
		From member right join (
		    Select to_date('20181205', 'yyyyMMdd')+(level-1) as ymd
		    From dual
		    Connect by level <![CDATA[ < ]]>= sysdate - (to_date('20181205', 'yyyyMMdd'))+1) a
		On  (to_char(mem_date, 'YYYY/MM/dd') = a.ymd)
		Where mem_mngr is null
		Group by  a.ymd
		Order by a.ymd
	</select>
	
	<!-- 5일부터 오늘까지 일별 탈퇴한 회원 수 -->
	<select id="signOutDaily" resultType="memVo">
		Select count(mem_exdate) as counts, a.ymd as ymd
		From member right join (
		    select to_date('20181205', 'yyyyMMdd')+(level-1) as ymd
		    from dual
		    connect by level <![CDATA[ < ]]>= sysdate - (to_date('20181205', 'yyyyMMdd'))+1) a
		On  (to_char(mem_date, 'YYYY/MM/dd') = a.ymd)
		Where mem_mngr is null
		Group by  a.ymd
		Order by a.ymd
	</select>
	
	<!-- 2018.11 이후 달별 가입한 회원 수 -->
	<select id="signInMonthly" resultType="memVo">
		Select count(mem_date) as counts , to_char(a.ymd,'YYYY/MM') as ymd
		From member right join (
    	Select add_months(to_date('201811', 'yyyyMM'),(level-1)) as ymd
    	From dual
    	Connect by level <![CDATA[ < ]]>= months_between( add_months(sysdate,1) , to_date('201811', 'yyyyMM'))) a
		On  (to_char(mem_date, 'YYYY/MM') = to_char(a.ymd,'YYYY/MM'))
		Where mem_mngr is null
		Group by  to_char(a.ymd,'YYYY/MM')
		Order by to_char(a.ymd,'YYYY/MM')
	</select>
	
	<!-- 2018.11 이후 달별 탈퇴한 회원 수 -->
	<select id="signOutMonthly" resultType="memVo">
		Select count(mem_exdate) as counts , to_char(a.ymd,'YYYY/MM') as ymd
		From member right join (
    	Select add_months(to_date('201811', 'yyyyMM'),(level-1)) as ymd
    	From dual
    	Connect by level <![CDATA[ < ]]>= months_between( add_months(sysdate,1) , to_date('201811', 'yyyyMM'))) a
		On  (to_char(mem_exdate, 'YYYY/MM') = to_char(a.ymd,'YYYY/MM'))
		Where mem_mngr is null
		Group by  to_char(a.ymd,'YYYY/MM')
		Order by to_char(a.ymd,'YYYY/MM')
	</select>
	
	<!-- 연령별/성별 가입 회원 수 -->
	<select id="signInAgeGndr" resultType="memVo">
		Select count(mem_no) as counts , mem_gndr, mem_age
		From member
		Where mem_gndr is not null
		And  mem_age is not null
		Group by mem_gndr, mem_age
		Order by mem_gndr, mem_age
	</select>
	
<!-- ** 찜 통계 ** -->
	<!-- 개별 찜 받은 개수 -->
	<select id="favorEach" resultType="favorVo">	
		Select favor_gu, favor_dong, favor_zip, favor_rd, counts, bc_nm, 
     	Row_number() Over ( Order by counts desc) as rank
		From (Select count(*) as counts, favor_gu, favor_dong, favor_zip, favor_rd From favorite Group by favor_gu, favor_dong, favor_zip, favor_rd)
		    Inner Join article on (favor_gu = artcl_gu and favor_dong = artcl_dong and favor_zip = artcl_zip and favor_rd = artcl_rd)
		    Inner Join building_classf on ( artcl_bc = bc_no)
		Where Rownum <![CDATA[ < ]]>= 30
	</select>
	
	<!-- 동별 찜 받은 개수 -->
	<select id="favorDong" resultType="favorVo">		
		Select favor_gu, favor_dong, counts, 
		     Row_number() Over ( Order by counts desc) as rank
		From (Select count(*) as counts, favor_gu, favor_dong From favorite Group by favor_gu, favor_dong)
		Where Rownum <![CDATA[ < ]]>= 20
	</select>
	
	<!-- 구별 찜 받은 개수 -->
	<select id="favorGu" resultType="favorVo">	
		Select favor_gu, counts, 
		     Row_number() Over ( Order by counts desc) as rank
		From (Select count(*) as counts, favor_gu From favorite Group by favor_gu)
	</select>
	
<!-- 관심사 통계 -->
	<!-- 관심사 수 최대치 -->
	<select id="countAllIntrst" resultType="int">
		Select Max(counts) From (Select Count(intrst_no) as counts, intrst_no From mem_inter Group by intrst_no)
	</select>
	
	<!-- 관심사별 선택 수 -->
	<select id="intrstAll" resultType="intrstVo">
		Select count(member.mem_no) counts, interest.intrst_no intrst_no, interest.intrst_nm intrst_nm
		From member Inner join mem_inter On (member.mem_no = mem_inter.mem_no)
		            Right Outer join interest On (mem_inter.intrst_no = interest.intrst_no)
		Group by interest.intrst_no, interest.intrst_nm
		Order by interest.intrst_no
	</select>
	
	<!-- 연령 리스트 -->
	<select id="ageList" resultType="string">
		Select Distinct mem_age From member Where mem_age is not null Order by 1
	</select>
	
	<!-- 연령별/성별+총 관심사 -->
	<select id="intrstAge" parameterType="String" resultType="intrstVo">
		Select Distinct I.INTRST_NO intrst_no
		     , I.INTRST_NM intrst_nm
		     , (Select Count(*) CNT From MEM_INTER MI, MEMBER M Where MI.MEM_NO = M.MEM_NO And INTRST_NO = I.INTRST_NO And MEM_GNDR = 'F' And mem_age = #{mem_age}) female
		     , (Select Count(*) CNT From MEM_INTER MI, MEMBER M Where MI.MEM_NO = M.MEM_NO And INTRST_NO = I.INTRST_NO And MEM_GNDR = 'M' And mem_age = #{mem_age}) male
		     , (Select Count(*) CNT From MEM_INTER MI, MEMBER M Where MI.MEM_NO = M.MEM_NO And INTRST_NO = I.INTRST_NO And mem_age = #{mem_age}) counts
		From   INTEREST I
	</select>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
<!-- dummyData 연령대 추가 -->
	<insert id="test" parameterType="memVo">
		Update member Set mem_age=#{mem_age} Where mem_no=#{mem_no}
	</insert>
	
	
	
</mapper>






















